"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getTracks = exports.getTracksFromIsoBaseMedia = exports.hasTracks = exports.isoBaseMediaHasTracks = exports.getNumberOfTracks = void 0;
const make_track_1 = require("./boxes/iso-base-media/make-track");
const traversal_1 = require("./boxes/iso-base-media/traversal");
const get_tracks_from_avi_1 = require("./boxes/riff/get-tracks-from-avi");
const get_tracks_1 = require("./boxes/transport-stream/get-tracks");
const get_ready_tracks_1 = require("./boxes/webm/get-ready-tracks");
const traversal_2 = require("./boxes/webm/traversal");
const getNumberOfTracks = (moovBox) => {
    const mvHdBox = (0, traversal_1.getMvhdBox)(moovBox);
    if (!mvHdBox) {
        return 0;
    }
    return mvHdBox.nextTrackId - 1;
};
exports.getNumberOfTracks = getNumberOfTracks;
const isoBaseMediaHasTracks = (structure) => {
    const moovBox = (0, traversal_1.getMoovBox)(structure.boxes);
    if (!moovBox) {
        return false;
    }
    const numberOfTracks = (0, exports.getNumberOfTracks)(moovBox);
    const tracks = (0, traversal_1.getTraks)(moovBox);
    return tracks.length === numberOfTracks;
};
exports.isoBaseMediaHasTracks = isoBaseMediaHasTracks;
const hasTracks = (structure, state) => {
    if (structure.type === 'matroska') {
        const mainSegment = (0, traversal_2.getMainSegment)(structure.boxes);
        if (!mainSegment) {
            return false;
        }
        return (0, traversal_2.getTracksSegment)(mainSegment) !== null;
    }
    if (structure.type === 'iso-base-media') {
        return (0, exports.isoBaseMediaHasTracks)(structure);
    }
    if (structure.type === 'riff') {
        return (0, get_tracks_from_avi_1.hasAllTracksFromAvi)(structure, state);
    }
    if (structure.type === 'transport-stream') {
        return (0, get_tracks_1.hasAllTracksFromTransportStream)(structure, state);
    }
    throw new Error('Unknown container ' + structure);
};
exports.hasTracks = hasTracks;
const getTracksFromMa = (segments, state) => {
    const videoTracks = [];
    const audioTracks = [];
    const otherTracks = [];
    const mainSegment = segments.find((s) => s.type === 'Segment');
    if (!mainSegment) {
        throw new Error('No main segment found');
    }
    const matroskaTracks = (0, get_ready_tracks_1.getTracksFromMatroska)(mainSegment, state.webm.getTimescale());
    for (const track of matroskaTracks) {
        if (track.type === 'video') {
            videoTracks.push(track);
        }
        else if (track.type === 'audio') {
            audioTracks.push(track);
        }
        else if (track.type === 'other') {
            otherTracks.push(track);
        }
    }
    return {
        videoTracks,
        audioTracks,
        otherTracks,
    };
};
const getTracksFromIsoBaseMedia = (segments) => {
    const videoTracks = [];
    const audioTracks = [];
    const otherTracks = [];
    const moovBox = (0, traversal_1.getMoovBox)(segments);
    if (!moovBox) {
        return {
            videoTracks,
            audioTracks,
            otherTracks,
        };
    }
    const tracks = (0, traversal_1.getTraks)(moovBox);
    for (const trakBox of tracks) {
        const track = (0, make_track_1.makeBaseMediaTrack)(trakBox);
        if (!track) {
            continue;
        }
        if (track.type === 'video') {
            videoTracks.push(track);
        }
        else if (track.type === 'audio') {
            audioTracks.push(track);
        }
        else if (track.type === 'other') {
            otherTracks.push(track);
        }
    }
    return {
        videoTracks,
        audioTracks,
        otherTracks,
    };
};
exports.getTracksFromIsoBaseMedia = getTracksFromIsoBaseMedia;
const getTracks = (segments, state) => {
    if (segments.type === 'matroska') {
        return getTracksFromMa(segments.boxes, state);
    }
    if (segments.type === 'iso-base-media') {
        return (0, exports.getTracksFromIsoBaseMedia)(segments.boxes);
    }
    if (segments.type === 'riff') {
        return (0, get_tracks_from_avi_1.getTracksFromAvi)(segments, state);
    }
    if (segments.type === 'transport-stream') {
        return (0, get_tracks_1.getTracksFromTransportStream)(segments, state);
    }
    throw new Error(`Unknown container${segments}`);
};
exports.getTracks = getTracks;
